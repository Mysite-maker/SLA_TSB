<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLPI SLA Dashboard - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --brand-indigo: #4f46e5;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transform: translateY(-2px);
        }

        .chart-container {
            padding: 1.5rem;
        }

        .data-table-container::-webkit-scrollbar,
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .data-table-container::-webkit-scrollbar-track,
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .data-table-container::-webkit-scrollbar-thumb,
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .data-table-container::-webkit-scrollbar-thumb:hover,
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .sla-breach {
            background-color: #fff1f2 !important;
            border-left: 4px solid #f43f5e;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            color: #64748b;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            transition: background 0.2s;
        }

        .legend-item:hover {
            background: #f1f5f9;
        }

        .legend-box {
            width: 10px;
            height: 10px;
            margin-right: 8px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .tooltip {
            position: absolute;
            padding: 8px;
            background: rgba(15, 23, 42, 0.9);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .axis-text {
            font-size: 10px;
            font-weight: 600;
            fill: #94a3b8;
        }

        .axis-line path,
        .axis-line line {
            stroke: #e2e8f0;
        }

        .grid line {
            stroke: #f1f5f9;
            stroke-opacity: 0.8;
            shape-rendering: crispEdges;
        }

        .grid path {
            stroke-width: 0;
        }

        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }

        .drop-zone:hover {
            border-color: #6366f1;
            background-color: #eef2ff;
        }

        .drop-zone.dragover {
            border-color: #6366f1;
            background-color: #eef2ff;
        }
    </style>
</head>

<body class="antialiased pb-12">

    <!-- Landing Page -->
    <div id="landing-page" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-6xl w-full">
            <div class="text-center mb-12">
                <h1 class="text-5xl font-extrabold text-slate-900 mb-3">
                    GLPI <span class="text-indigo-600">SLA Dashboard</span>
                </h1>
                <p class="text-slate-500 text-lg font-medium">Incident Performance & Resolution Analytics</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Merge CSV Section -->
                <div class="card p-8">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-3 bg-indigo-50 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800">Merge CSV Files(Option)</h2>
                    </div>
                    <p class="text-slate-500 mb-6">Combine multiple GLPI export files into one before processing.</p>

                    <div id="merge-drop-area" class="drop-zone p-12 rounded-xl text-center cursor-pointer mb-4">
                        <input type="file" id="merge-file-input" multiple accept=".csv" class="hidden">
                        <label for="merge-file-input" class="cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-slate-400"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="text-slate-600 font-semibold mb-1">Select multiple files to merge</p>
                            <p class="text-sm text-slate-400">Click or drag & drop CSV files here</p>
                        </label>
                    </div>

                    <div id="merge-file-list-container" class="hidden mb-4">
                        <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Selected Files:</h3>
                        <ul id="merge-file-list"
                            class="text-sm text-slate-700 space-y-1 bg-slate-50 p-3 rounded-lg border max-h-32 overflow-y-auto">
                        </ul>
                    </div>

                    <button id="merge-btn"
                        class="w-full bg-slate-200 text-slate-400 font-bold py-3 px-4 rounded-xl transition disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                        Merge & Download to GLPI3.CSV
                    </button>
                </div>

                <!-- Import & Analyze Section -->
                <div class="card p-8">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-3 bg-emerald-50 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-emerald-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800">Import & Analyze</h2>
                    </div>
                    <p class="text-slate-500 mb-6">Upload your single or merged CSV file to view the SLA dashboard.</p>

                    <label for="dashboard-csv-file-input" class="block mt-16">
                        <input type="file" id="dashboard-csv-file-input" accept=".csv" class="hidden">
                        <div
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition text-center cursor-pointer flex items-center justify-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            <span>Choose GLPI.CSV to Open Dashboard</span>
                        </div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard (Hidden Initially) -->
    <div id="app" class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 pt-8 hidden">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">
                    GLPI <span class="text-indigo-600">SLA Performance</span>
                </h1>
                <p class="text-slate-500 mt-1 font-medium">Service Level Agreement Monitoring & Technician Analytics</p>
            </div>

            <div class="flex flex-wrap items-center gap-3">
                <nav class="flex bg-slate-100 p-1 rounded-xl mr-2">
                    <button id="nav-performance"
                        class="px-6 py-2 rounded-lg font-bold text-sm transition bg-white text-indigo-600 shadow-sm">Performance</button>
                    <button id="nav-analysis"
                        class="px-6 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700">Analysis</button>
                </nav>
                <button id="back-to-landing"
                    class="flex items-center gap-2 px-6 py-3 bg-slate-100 hover:bg-slate-200 rounded-xl transition text-slate-700 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Home
                </button>
            </div>
        </header>

        <!-- Loading Overlay -->
        <div id="loading-message"
            class="fixed inset-0 bg-slate-900/10 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center">
                <svg class="animate-spin h-12 w-12 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <p class="text-lg font-bold text-slate-800 tracking-wide">Analysing Records...</p>
            </div>
        </div>

        <!-- Dashboard Body -->
        <div id="page-performance" class="space-y-8 animate-in fade-in duration-700">

            <!-- Filters Toolbar -->
            <section
                class="bg-white border border-slate-200 p-6 rounded-2xl shadow-sm grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Opened
                        From</label>
                    <input type="date" id="date-start"
                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Opened
                        To</label>
                    <input type="date" id="date-end"
                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Location</label>
                    <select id="location-filter"
                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                        <option value="ALL">All Regions</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">SLA
                        Status</label>
                    <select id="sla-filter"
                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                        <option value="ALL">All Tickets</option>
                        <option value="Yes" class="text-red-600 font-bold">Exceeded (Breached)</option>
                        <option value="No" class="text-green-600 font-bold">Met (Compliant)</option>
                    </select>
                </div>
            </section>

            <!-- KPI Row -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card p-6 border-l-8 border-indigo-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-slate-500 font-bold text-xs uppercase tracking-widest">Total Tickets</h3>
                        <div class="p-2 bg-indigo-50 rounded-lg"><svg class="w-5 h-5 text-indigo-600" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                </path>
                            </svg></div>
                    </div>
                    <div id="total-tickets" class="text-4xl font-extrabold text-slate-900">0</div>
                    <p class="text-slate-400 text-xs mt-2">Active records in current scope</p>
                </div>

                <div class="card p-6 border-l-8 border-rose-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-slate-500 font-bold text-xs uppercase tracking-widest">SLA Distribution</h3>
                        <div class="p-2 bg-rose-50 rounded-lg"><svg class="w-5 h-5 text-rose-600" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg></div>
                    </div>
                    <div class="flex items-end gap-2">
                        <span id="sla-exceeded-count" class="text-4xl font-extrabold text-rose-600">0</span>
                        <span class="text-slate-300 font-light text-2xl mb-1">/</span>
                        <span id="sla-met-count" class="text-2xl font-bold text-emerald-600 mb-1">0</span>
                    </div>
                    <div class="w-full bg-slate-100 h-2 rounded-full mt-4 overflow-hidden flex">
                        <div id="sla-bar-exceeded" class="bg-rose-500 h-full transition-all duration-500"
                            style="width: 0%"></div>
                        <div id="sla-bar-met" class="bg-emerald-500 h-full transition-all duration-500"
                            style="width: 0%"></div>
                    </div>
                </div>

                <div class="card p-6 border-l-8 border-amber-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-slate-500 font-bold text-xs uppercase tracking-widest">KPI Compliance Rate</h3>
                        <div class="p-2 bg-amber-50 rounded-lg"><svg class="w-5 h-5 text-amber-600" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg></div>
                    </div>
                    <div id="sla-met-percent" class="text-4xl font-extrabold text-slate-900">0%</div>
                    <p class="text-slate-400 text-xs mt-2"><span id="sla-exceeded-percent"
                            class="text-rose-500 font-bold">0%</span> breach rate detected</p>
                </div>
            </section>

            <!-- Main Charts -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="card p-6 lg:col-span-1">
                    <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                        <span class="w-2 h-6 bg-indigo-500 rounded mr-3"></span>
                        Tickets Status
                    </h2>
                    <div class="relative h-80">
                        <svg id="chart-status" class="w-full h-full"></svg>
                    </div>
                </div>

                <div class="card p-6 lg:col-span-2" id="location-chart-container">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center">
                            <span class="w-2 h-6 bg-indigo-500 rounded mr-3"></span>
                            Location Analysis (Volume & Category)
                        </h2>
                    </div>
                    <div class="overflow-x-auto">
                        <div id="location-scroll-wrapper"
                            class="w-full max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                            <svg id="chart-location" class="w-full"></svg>
                        </div>
                    </div>
                    <div id="location-legend" class="flex flex-wrap gap-2 justify-center mt-6 border-t pt-4"></div>
                </div>
            </section>

            <!-- Detailed Log -->
            <section class="card overflow-hidden">
                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center justify-between">
                    <h2 class="text-lg font-bold text-slate-800">Tickets detail</h2>
                    <div class="flex items-center gap-3">
                        <label class="text-xs font-bold text-slate-400 uppercase">Sort By:</label>
                        <select id="sort-filter"
                            class="bg-white border-slate-200 rounded-lg px-3 py-1 text-xs focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                            <option value="date">Date (Oldest)</option>
                            <option value="location">Location</option>
                            <option value="plate">Plate</option>
                        </select>
                    </div>
                </div>
                <div class="data-table-container overflow-auto max-h-[500px]">
                    <table id="ticket-details-table" class="w-full text-left text-sm border-collapse">
                        <thead class="sticky top-0 bg-slate-50 z-20 border-b-2 border-slate-200">
                            <tr>
                                <th class="px-4 py-3 text-slate-500 font-bold">ID</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Ticket Subject</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Status</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Technician</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Category</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Location</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Plate</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Open Date</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">SLA</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- Technician Deep Dive -->
            <section class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Pie Chart -->
                <div class="card p-6 lg:col-span-4">
                    <h2 class="text-lg font-bold text-slate-800 mb-6">Workload Allocation</h2>
                    <div class="flex flex-col items-center">
                        <svg id="chart-technician-pie" class="w-full h-72"></svg>
                        <div id="technician-legend" class="mt-6 w-full space-y-1 max-h-48 overflow-y-auto pr-2"></div>
                    </div>
                </div>

                <!-- KPI Leaderboard -->
                <div class="card p-6 lg:col-span-8 overflow-hidden">
                    <h2 class="text-lg font-bold text-slate-800 mb-6">Technician KPI Matrix</h2>
                    <div class="overflow-x-auto rounded-xl border border-slate-100">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4 font-bold text-slate-600">Technician</th>
                                    <th class="px-6 py-4 font-bold text-slate-600 text-center">Volume</th>
                                    <th class="px-6 py-4 font-bold text-slate-600 text-center">Solved (SLA Met)</th>
                                    <th class="px-6 py-4 font-bold text-slate-600 text-center">SLA Compliance</th>
                                    <th class="px-6 py-4 font-bold text-slate-600">Performance Index</th>
                                </tr>
                            </thead>
                            <tbody id="tech-kpi-body" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <!-- Analysis Page (Page 2) -->
        <div id="page-analysis" class="space-y-8 animate-in fade-in duration-700 hidden">
            <!-- Filters Toolbar Page 2 -->
            <section
                class="bg-white border border-slate-200 p-6 rounded-2xl shadow-sm grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Opened
                        From</label>
                    <input type="date" id="date-start-p2"
                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Opened
                        To</label>
                    <input type="date" id="date-end-p2"
                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Location</label>
                    <select id="location-filter-p2"
                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                        <option value="ALL">All Regions</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Plate
                    </label>
                    <select id="plate-filter-p2"
                        class="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                        <option value="ALL">All Plates</option>
                    </select>
                </div>
            </section>

            <!-- Row 1: Pie Charts -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                        <span class="w-2 h-6 bg-emerald-500 rounded mr-3"></span>
                        Category Distribution
                    </h2>
                    <div class="flex flex-col items-center">
                        <svg id="chart-category-pie-p2" class="w-full h-80"></svg>
                        <div id="category-legend-p2"
                            class="mt-6 w-full flex flex-wrap gap-2 justify-center border-t pt-4"></div>
                    </div>
                </div>
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                        <span class="w-2 h-6 bg-indigo-500 rounded mr-3"></span>
                        Location Analysis by Category
                    </h2>
                    <div class="flex flex-col items-center">
                        <div id="treemap-container-p2" class="w-full h-80 overflow-hidden">
                            <svg id="chart-location-treemap-p2" class="w-full h-full"></svg>
                        </div>
                        <div id="location-treemap-legend-p2"
                            class="mt-6 w-full flex flex-wrap gap-2 justify-center border-t pt-4"></div>
                    </div>
                </div>
            </section>

            <!-- Row 2: Plate Analysis Stacked Bar -->
            <section class="card p-6" id="plate-chart-container-p2">
                <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                    <span class="w-2 h-6 bg-amber-500 rounded mr-3"></span>
                    Plate Analysis (Volume & Category)
                </h2>
                <div class="overflow-x-auto">
                    <div id="plate-scroll-wrapper-p2"
                        class="w-full max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                        <svg id="chart-plate-bar-p2" class="w-full"></svg>
                    </div>
                </div>
                <div id="plate-legend-p2" class="flex flex-wrap gap-2 justify-center mt-6 border-t pt-4"></div>
            </section>

            <!-- Ticket Detail Sorted by Plate -->
            <section class="card overflow-hidden">
                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center justify-between">
                    <h2 class="text-lg font-bold text-slate-800">Tickets Detail (Analysis View)</h2>
                    <div class="flex items-center gap-3">
                        <label class="text-xs font-bold text-slate-400 uppercase">Sort By:</label>
                        <select id="sort-filter-p2"
                            class="bg-white border-slate-200 rounded-lg px-3 py-1 text-xs focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                            <option value="plate">Plate (A-Z)</option>
                            <option value="date">Date (Oldest)</option>
                            <option value="location">Location</option>
                        </select>
                    </div>
                </div>
                <div class="data-table-container overflow-auto max-h-[500px]">
                    <table id="ticket-details-table-p2" class="w-full text-left text-sm border-collapse">
                        <thead class="sticky top-0 bg-slate-50 z-20 border-b-2 border-slate-200">
                            <tr>
                                <th class="px-4 py-3 text-slate-500 font-bold">ID</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Ticket Subject</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Status</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Technician</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Category</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Location</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Plate</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">Open Date</th>
                                <th class="px-4 py-3 text-slate-500 font-bold">SLA</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Suppress console messages
        console.log = function () { };
        console.warn = function () { };
        console.error = function () { };
        console.info = function () { };
        console.debug = function () { };

        let rawData = [];
        let filteredData = [];
        let filteredDataP2 = [];
        let allCategories = [];
        let currentPage = 'performance';
        const delimiter = ';';
        const DATE_FORMAT = d3.timeParse("%d-%m-%Y %H:%M");
        const TABLE_DATE_FORMAT = d3.timeFormat("%b %d, %H:%M");
        const BAR_ROW_HEIGHT = 45;

        const categoryColorMap = {
            'AVM': '#4e79a7',
            'CCTV': '#f28e2c',
            'E60': '#e15759',
            'GPS': '#76b7b2',
            'MDVR': '#59a14f',
            'Z90': '#edc948',
            'Navigation > GPS': '#b07aa1',
            'Request Video Playback': '#ff9da7',
            'Security and Access Control > MDVR': '#9c755f',
            'Swipe machine': '#bab0ab',
            'Other': '#d3d3d3',
            'Unspecified': '#d3d3d3'
        };

  // 1. à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸±à¸§à¸ˆà¹ˆà¸²à¸¢à¸ªà¸µà¸ªà¸³à¸£à¸­à¸‡à¹„à¸§à¹‰à¸”à¹‰à¸²à¸™à¸™à¸­à¸ (à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸¡à¸±à¸™à¸ˆà¸³à¹„à¸”à¹‰à¸§à¹ˆà¸²à¸ˆà¹ˆà¸²à¸¢à¸ªà¸µà¸­à¸°à¹„à¸£à¹„à¸›à¹à¸¥à¹‰à¸§)
const defaultScale = d3.scaleOrdinal(d3.schemeTableau10);

// 2. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¸ˆà¸°à¹€à¸¥à¸·à¸­à¸à¸ªà¸µà¸ˆà¸²à¸ Map à¸à¹ˆà¸­à¸™ à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸«à¹‰à¹„à¸›à¸”à¸¶à¸‡à¸ˆà¸²à¸à¸•à¸±à¸§à¸ªà¸³à¸£à¸­à¸‡à¸”à¹‰à¸²à¸™à¸šà¸™
const getCategoryColor = (cat) => {
    return categoryColorMap[cat] || defaultScale(cat);
};

        const statusConfig = {
            'Closed': { bg: 'bg-emerald-100', border: 'border-emerald-200', text: 'text-emerald-700', color: '#059669', group: 'Closed' },
            'Solved': { bg: 'bg-teal-50', border: 'border-teal-200', text: 'text-teal-700', color: '#14b8a6', group: 'Solved' },
            'Processing (assigned)': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', color: '#3b82f6', group: 'Active' },
            'New': { bg: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-700', color: '#6366f1', group: 'Active' },
            'Pending': { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700', color: '#f59e0b', group: 'Active' },
            'Waiting': { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-700', color: '#a855f7', group: 'Active' }
        };
        const defaultStatus = { bg: 'bg-slate-50', border: 'border-slate-200', text: 'text-slate-700', color: '#94a3b8', group: 'Active' };

        const tooltip = d3.select("body").append("div").attr("class", "tooltip opacity-0");

        // Cached DOM Elements
        let elements = {};
        function cacheElements() {
            const ids = [
                'total-tickets', 'sla-exceeded-count', 'sla-met-count',
                'sla-met-percent', 'sla-exceeded-percent',
                'sla-bar-exceeded', 'sla-bar-met',
                'date-start', 'date-end', 'location-filter', 'sla-filter',
                'date-start-p2', 'date-end-p2', 'location-filter-p2', 'plate-filter-p2',
                'sort-filter', 'sort-filter-p2'
            ];
            ids.forEach(id => {
                elements[id] = document.getElementById(id);
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        function downloadFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        let mergeSelectedFiles = [];
        const mergeFileInput = document.getElementById('merge-file-input');
        const mergeFileList = document.getElementById('merge-file-list');
        const mergeFileListContainer = document.getElementById('merge-file-list-container');
        const mergeBtn = document.getElementById('merge-btn');
        const mergeDropArea = document.getElementById('merge-drop-area');

        mergeFileInput.addEventListener('change', (e) => {
            mergeSelectedFiles = Array.from(e.target.files);
            updateMergeUI();
        });

        function updateMergeUI() {
            mergeFileList.innerHTML = '';
            if (mergeSelectedFiles.length > 0) {
                mergeSelectedFiles.forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = `ðŸ“„ ${file.name}`;
                    li.className = 'text-slate-600';
                    mergeFileList.appendChild(li);
                });
                mergeFileListContainer.classList.remove('hidden');
                mergeBtn.disabled = false;
                mergeBtn.classList.remove('bg-slate-200', 'text-slate-400');
                mergeBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
            } else {
                mergeFileListContainer.classList.add('hidden');
                mergeBtn.disabled = true;
                mergeBtn.classList.add('bg-slate-200', 'text-slate-400');
                mergeBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
            }
        }

        mergeBtn.addEventListener('click', async () => {
            if (mergeSelectedFiles.length === 0) return;

            try {
                let mergedContent = '';
                let headerWritten = false;

                for (let i = 0; i < mergeSelectedFiles.length; i++) {
                    const content = await readFileAsText(mergeSelectedFiles[i]);
                    const lines = content.split('\n');

                    if (i === 0) {
                        mergedContent = content;
                        headerWritten = true;
                    } else {
                        const dataLines = lines.slice(1).join('\n');
                        if (mergedContent.length > 0 && !mergedContent.endsWith('\n')) {
                            mergedContent += '\n';
                        }
                        mergedContent += dataLines;
                    }
                }

                downloadFile(mergedContent, 'glpi3.csv');

                mergeBtn.textContent = 'âœ“ Downloaded!';
                setTimeout(() => {
                    mergeBtn.textContent = 'Merge & Download to GLPI3.CSV';
                }, 2000);
            } catch (err) {
                console.error(err);
                alert('Error merging files. Please try again.');
            }
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            mergeDropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        mergeDropArea.addEventListener('dragenter', () => {
            mergeDropArea.classList.add('dragover');
        });

        mergeDropArea.addEventListener('dragleave', () => {
            mergeDropArea.classList.remove('dragover');
        });

        mergeDropArea.addEventListener('drop', (e) => {
            mergeDropArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            mergeFileInput.files = files;
            mergeSelectedFiles = Array.from(files);
            updateMergeUI();
        });

        const dashboardFileInput = document.getElementById('dashboard-csv-file-input');
        dashboardFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loading-message').classList.remove('hidden');
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (event) => {
                rawData = parseCSV(event.target.result);
                document.getElementById('page-performance').classList.remove('hidden');
                cacheElements();
                initializeFilters(rawData);
                document.getElementById('loading-message').classList.add('hidden');
            };
            reader.readAsText(file);
        });

        const navPerf = document.getElementById('nav-performance');
        const navAnalysis = document.getElementById('nav-analysis');

        navPerf.addEventListener('click', () => switchPage('performance'));
        navAnalysis.addEventListener('click', () => switchPage('analysis'));

        function switchPage(page) {
            currentPage = page;
            const pPerf = document.getElementById('page-performance');
            const pAnalysis = document.getElementById('page-analysis');

            if (page === 'performance') {
                pPerf.classList.remove('hidden');
                pAnalysis.classList.add('hidden');
                navPerf.classList.add('bg-white', 'text-indigo-600', 'shadow-sm');
                navPerf.classList.remove('text-slate-500');
                navAnalysis.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm');
                navAnalysis.classList.add('text-slate-500');
                updateDashboard(true);
            } else {
                pPerf.classList.add('hidden');
                pAnalysis.classList.remove('hidden');
                navAnalysis.classList.add('bg-white', 'text-indigo-600', 'shadow-sm');
                navAnalysis.classList.remove('text-slate-500');
                navPerf.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm');
                navPerf.classList.add('text-slate-500');
                updateDashboardP2(true);
            }
        }

        document.getElementById('back-to-landing').addEventListener('click', () => {
            document.getElementById('app').classList.add('hidden');
            document.getElementById('landing-page').classList.remove('hidden');
            document.getElementById('page-performance').classList.add('hidden');
            document.getElementById('page-analysis').classList.add('hidden');
            switchPage('performance');
            rawData = [];
            filteredData = [];
            filteredDataP2 = [];
            dashboardFileInput.value = '';
        });

        function parseCSV(csvText) {
            const parser = d3.dsvFormat(delimiter);
            return parser.parse(csvText).map(d => ({
                ...d,
                opening_date: DATE_FORMAT(d['Opening Date']),
                location: d.Locations || "Unspecified",
                tech: d['Assigned To - Technician'] || "No Technician",
                plate: d['Associated elements'] || d['Associated Elements'] || "Unknown",
                sla_breach: d['Time to resolve exceeded'] === 'Yes'
            })).filter(d => d.opening_date);
        }

        function initializeFilters(data) {
            // Page 1 Filters
            const locationFilter = document.getElementById('location-filter');
            locationFilter.innerHTML = '<option value="ALL">All Regions</option>';
            const locations = [...new Set(data.map(d => d.location))].sort();
            locations.forEach(l => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = l;
                locationFilter.appendChild(opt);
            });

            // Page 2 Filters
            const locationFilterP2 = document.getElementById('location-filter-p2');
            locationFilterP2.innerHTML = '<option value="ALL">All Regions</option>';
            locations.forEach(l => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = l;
                locationFilterP2.appendChild(opt);
            });

            const plateFilterP2 = document.getElementById('plate-filter-p2');
            plateFilterP2.innerHTML = '<option value="ALL">All Plates</option>';
            const plates = [...new Set(data.map(d => d.plate))].sort();
            plates.forEach(p => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = p;
                plateFilterP2.appendChild(opt);
            });

            const minDate = d3.min(data, d => d.opening_date);
            const maxDate = d3.max(data, d => d.opening_date);

            allCategories = [...new Set(data.map(d => d.Category || "Other"))].sort();

            if (minDate && maxDate) {
                const iso = d => d.toISOString().split('T')[0];
                document.getElementById('date-start').value = iso(minDate);
                document.getElementById('date-end').value = iso(maxDate);
                document.getElementById('date-start-p2').value = iso(minDate);
                document.getElementById('date-end-p2').value = iso(maxDate);
            }

            document.querySelectorAll('#page-performance input, #page-performance select').forEach(el => el.onchange = () => updateDashboard());
            document.querySelectorAll('#page-analysis input, #page-analysis select').forEach(el => el.onchange = () => updateDashboardP2());
            updateDashboard();
        }

        function applyFilters() {
            const startDateStr = elements['date-start'].value;
            const endDateStr = elements['date-end'].value;
            const loc = elements['location-filter'].value;
            const sla = elements['sla-filter'].value;

            const start = startDateStr ? new Date(startDateStr) : null;
            const end = endDateStr ? new Date(endDateStr) : null;
            if (end) end.setHours(23, 59, 59);

            filteredData = rawData.filter(d => {
                const dateMatch = (!start || d.opening_date >= start) && (!end || d.opening_date <= end);
                const locMatch = loc === 'ALL' || d.location === loc;
                const slaMatch = sla === 'ALL' || d['Time to resolve exceeded'] === sla;
                return dateMatch && locMatch && slaMatch;
            });
        }

        function applyFiltersP2() {
            const startDateStr = elements['date-start-p2'].value;
            const endDateStr = elements['date-end-p2'].value;
            const loc = elements['location-filter-p2'].value;
            const plate = elements['plate-filter-p2'].value;

            const start = startDateStr ? new Date(startDateStr) : null;
            const end = endDateStr ? new Date(endDateStr) : null;
            if (end) end.setHours(23, 59, 59);

            filteredDataP2 = rawData.filter(d => {
                const dateMatch = (!start || d.opening_date >= start) && (!end || d.opening_date <= end);
                const locMatch = loc === 'ALL' || d.location === loc;
                const plateMatch = plate === 'ALL' || d.plate === plate;
                return dateMatch && locMatch && plateMatch;
            });
        }

        function updateDashboardP2(force = false) {
            if (!force && currentPage !== 'analysis') return;
            applyFiltersP2();
            renderCategoryPieChartP2();
            renderLocationTreemapP2();
            renderPlateStackedBarP2();
            renderTableP2();
        }

        function renderGenericPie(svg, legend, data) {
            const width = 400, height = 300, radius = Math.min(width, height) / 2 - 40;
            const total = d3.sum(data, d => d.value);

            const g = svg.attr("viewBox", `0 0 ${width} ${height}`)
                .append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);

            const pie = d3.pie().value(d => d.value).sort(null);
            const arc = d3.arc().innerRadius(radius * 0.4).outerRadius(radius);
            const hoverArc = d3.arc().innerRadius(radius * 0.4).outerRadius(radius + 10);

            const paths = g.selectAll(".arc")
                .data(pie(data))
                .enter().append("g");

            paths.append("path")
                .attr("d", arc)
                .attr("fill", d => getCategoryColor(d.data.name))
                .attr("stroke", "white")
                .attr("stroke-width", "2px")
                .style("transition", "all 0.3s")
                .on("mouseover", function (event, d) {
                    d3.select(this).attr("d", hoverArc).attr("opacity", 0.8);
                    tooltip.transition().duration(100).style("opacity", 1);
                    tooltip.html(`<strong>${d.data.name}</strong><br>${d.data.value} tickets (${(d.data.value / total * 100).toFixed(1)}%)`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function () {
                    d3.select(this).attr("d", arc).attr("opacity", 1);
                    tooltip.transition().duration(200).style("opacity", 0);
                });

            paths.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .attr("fill", "black")
                .attr("class", "text-[11px] font-bold pointer-events-none")
                .text(d => {
                    const pct = (d.data.value / total * 100);
                    return (d.endAngle - d.startAngle > 0.4) ? `${pct.toFixed(0)}%` : "";
                });

            data.forEach(d => {
                const item = legend.append("div").attr("class", "legend-item");
                item.append("div").attr("class", "legend-box").style("background-color", getCategoryColor(d.name));
                item.append("span").text(`${d.name} (${d.value})`);
            });
        }

        function renderCategoryPieChartP2() {
            const container = d3.select("#chart-category-pie-p2");
            const legend = d3.select("#category-legend-p2");
            container.selectAll("*").remove();
            legend.selectAll("*").remove();
            if (!filteredDataP2.length) return;
            const counts = d3.rollup(filteredDataP2, v => v.length, d => d.Category || "Other");
            const data = Array.from(counts, ([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
            renderGenericPie(container, legend, data);
        }

        function renderLocationTreemapP2() {
            const container = d3.select("#chart-location-treemap-p2");
            const legend = d3.select("#location-treemap-legend-p2");
            container.selectAll("*").remove();
            legend.selectAll("*").remove();
            if (!filteredDataP2.length) return;

            // Prepare hierarchical data: Root -> Category -> Location
            const nested = d3.rollup(filteredDataP2, v => v.length, d => d.Category || "Other", d => d.location);
            const rootData = {
                name: "root",
                children: Array.from(nested, ([cat, locations]) => ({
                    name: cat,
                    children: Array.from(locations, ([loc, count]) => ({
                        name: loc,
                        value: count
                    }))
                }))
            };

            const width = document.getElementById("treemap-container-p2").clientWidth;
            const height = 320;

            const root = d3.hierarchy(rootData)
                .sum(d => d.value)
                .sort((a, b) => b.value - a.value);

            d3.treemap()
                .size([width, height])
                .paddingInner(1)
                .paddingOuter(2)
                .paddingTop(0)(root);

            const svg = container.attr("width", width).attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`);

            const cell = svg.selectAll("g")
                .data(root.leaves())
                .enter().append("g")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);

            cell.append("rect")
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", d => getCategoryColor(d.parent.data.name))
                .attr("stroke", "white")
                .attr("stroke-width", "0.5px")
                .on("mouseover", function (event, d) {
                    tooltip.transition().duration(100).style("opacity", 1);
                    tooltip.html(`<strong>${d.parent.data.name}</strong><br>${d.data.name}: ${d.data.value} tickets`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    d3.select(this).attr("opacity", 0.8);
                })
                .on("mouseout", function () {
                    tooltip.transition().duration(200).style("opacity", 0);
                    d3.select(this).attr("opacity", 1);
                });

            cell.append("text")
                .attr("x", 4)
                .attr("y", 14)
                .attr("class", "fill-black font-bold text-[10px] pointer-events-none")
                .text(d => {
                    if ((d.x1 - d.x0) < 40 || (d.y1 - d.y0) < 20) return "";
                    return `${d.data.name} (${d.data.value})`;
                });

            // Legend for Categories only
            const topCategories = root.children.sort((a, b) => b.value - a.value);
            topCategories.forEach(d => {
                const item = legend.append("div").attr("class", "legend-item");
                item.append("div").attr("class", "legend-box").style("background-color", getCategoryColor(d.data.name));
                item.append("span").text(`${d.data.name} (${d.value})`);
            });
        }

        function renderPlateStackedBarP2() {
            const svg = d3.select("#chart-plate-bar-p2");
            const legend = d3.select("#plate-legend-p2");
            svg.selectAll("*").remove();
            legend.selectAll("*").remove();
            if (!filteredDataP2.length) return;

            const cats = allCategories;
            const colorScale = getCategoryColor;
            const grouped = d3.rollup(filteredDataP2,
                v => d3.rollup(v, g => g.length, d => d.Category || "Other"),
                d => d.plate + " (" + d.location + ")"
            );

            const data = Array.from(grouped, ([label, cMap]) => {
                const row = { label: label };
                let total = 0;
                cats.forEach(c => {
                    const count = cMap.get(c) || 0;
                    row[c] = count;
                    total += count;
                });
                row._total = total;
                return row;
            }).sort((a, b) => b._total - a._total);

            const margin = { top: 10, right: 60, bottom: 40, left: 180 };
            const containerWidth = document.getElementById("plate-chart-container-p2").clientWidth - 48;
            const width = Math.max(containerWidth, 600) - margin.left - margin.right;
            const height = data.length * BAR_ROW_HEIGHT;

            svg.attr("height", height + margin.top + margin.bottom)
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`);

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            const x = d3.scaleLinear().domain([0, d3.max(data, d => d._total) * 1.1 || 1]).range([0, width]);
            const y = d3.scaleBand().domain(data.map(d => d.label)).range([0, height]).padding(0.25);

            g.append("g").attr("class", "grid").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).ticks(5).tickSize(-height).tickFormat(""));
            g.append("g").attr("class", "axis-line axis-text").attr("transform", `translate(0, ${height})`).call(d3.axisBottom(x).ticks(5));
            g.append("g").call(d3.axisLeft(y).tickSize(0)).selectAll("text").attr("class", "font-bold text-slate-700").style("font-size", "10px");

            const stack = d3.stack().keys(cats)(data);
            const layer = g.selectAll(".layer").data(stack).enter().append("g").attr("fill", d => colorScale(d.key));

            layer.selectAll("rect")
                .data(d => d)
                .enter().append("rect")
                .attr("y", d => y(d.data.label))
                .attr("x", d => x(d[0]))
                .attr("width", d => Math.max(0, x(d[1]) - x(d[0])))
                .attr("height", y.bandwidth())
                .attr("rx", 4)
                .on("mouseover", function (event, d) {
                    const key = d3.select(this.parentNode).datum().key;
                    tooltip.transition().duration(100).style("opacity", 1);
                    tooltip.html(`<strong>${key}</strong>: ${d[1] - d[0]} tickets`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    d3.select(this).attr("opacity", 0.8);
                })
                .on("mouseout", function () {
                    tooltip.transition().duration(200).style("opacity", 0);
                    d3.select(this).attr("opacity", 1);
                });

            layer.selectAll(".bar-label")
                .data(d => d)
                .enter().append("text")
                .attr("y", d => y(d.data.label) + y.bandwidth() / 2)
                .attr("x", d => x(d[0]) + (x(d[1]) - x(d[0])) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .attr("fill", "white")
                .attr("class", "font-bold text-[9px] pointer-events-none")
                .text(d => (x(d[1]) - x(d[0]) > 20) ? (d[1] - d[0]) : "");

            g.selectAll(".total-label").data(data).enter().append("text")
                .attr("y", d => y(d.label) + y.bandwidth() / 2)
                .attr("x", d => x(d._total) + 8)
                .attr("dy", "0.35em")
                .attr("class", "font-bold text-slate-400 text-[10px]")
                .text(d => d._total);

            cats.forEach(c => {
                const item = legend.append("div").attr("class", "legend-item");
                item.append("div").attr("class", "legend-box").style("background-color", colorScale(c));
                item.append("span").text(c);
            });
        }

        function renderTableP2() {
            const tbody = document.querySelector('#ticket-details-table-p2 tbody');
            const sortKey = elements['sort-filter-p2'].value;

            const sorted = [...filteredDataP2].sort((a, b) => {
                if (sortKey === 'plate') return a.plate.localeCompare(b.plate);
                if (sortKey === 'location') return a.location.localeCompare(b.location);
                if (sortKey === 'date') return a.opening_date - b.opening_date;
                return 0;
            });

            tbody.innerHTML = sorted.map(d => {
                const config = statusConfig[d.Status] || defaultStatus;
                return `<tr class="${d.sla_breach ? 'sla-breach' : ''}">
                    <td class="px-4 py-3 font-mono text-slate-400 text-xs">${d.ID}</td>
                    <td class="px-4 py-3 font-semibold text-slate-700 truncate max-w-xs">${d.Title}</td>
                    <td class="px-4 py-3"><span class="status-pill ${config.bg} ${config.text} border ${config.border}">${d.Status}</span></td>
                    <td class="px-4 py-3 text-slate-500">${d.tech}</td>
                    <td class="px-4 py-3 text-slate-500 font-medium">${d.Category || '-'}</td>
                    <td class="px-4 py-3 text-slate-500">${d.location}</td>
                    <td class="px-4 py-3 font-bold text-indigo-600">${d.plate}</td>
                    <td class="px-4 py-3 text-slate-400">${TABLE_DATE_FORMAT(d.opening_date)}</td>
                    <td class="px-4 py-3">${d.sla_breach ? '<span class="text-rose-600 font-bold">BREACH</span>' : '<span class="text-emerald-500 font-medium">OK</span>'}</td>
                </tr>`;
            }).join('');
        }

        function updateStatistics() {
            let total = 0, exceeded = 0;
            for (let i = 0; i < filteredData.length; i++) {
                total++;
                if (filteredData[i].sla_breach) exceeded++;
            }
            const met = total - exceeded;
            const metRate = total > 0 ? (met / total * 100) : 0;
            const excRate = total > 0 ? (exceeded / total * 100) : 0;

            elements['total-tickets'].textContent = total.toLocaleString();
            elements['sla-exceeded-count'].textContent = exceeded.toLocaleString();
            elements['sla-met-count'].textContent = met.toLocaleString();

            elements['sla-met-percent'].textContent = `${metRate.toFixed(1)}%`;
            elements['sla-exceeded-percent'].textContent = `${excRate.toFixed(1)}%`;

            elements['sla-bar-exceeded'].style.width = `${excRate}%`;
            elements['sla-bar-met'].style.width = `${metRate}%`;
        }

        function renderStatusFunnel() {
            const container = d3.select("#chart-status");
            container.selectAll("*").remove();
            if (!filteredData.length) return;

            const counts = d3.rollup(filteredData, v => v.length, d => (statusConfig[d.Status] || defaultStatus).group);
            const data = [
                { name: 'Active', color: '#6366F1', val: counts.get('Active') || 0 },
                { name: 'Solved', color: '#14b8a6', val: counts.get('Solved') || 0 },
                { name: 'Closed', color: '#059669', val: counts.get('Closed') || 0 }
            ];

            const width = 400;
            const height = 300;
            const margin = { top: 40, right: 20, bottom: 40, left: 20 };

            const svg = container.attr("viewBox", `0 0 ${width} ${height}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const x = d3.scaleBand().domain(data.map(d => d.name)).range([0, chartWidth]).padding(0.3);
            const y = d3.scaleLinear().domain([0, d3.max(data, d => d.val) * 1.1 || 10]).range([chartHeight, 0]);

            svg.selectAll("rect")
                .data(data)
                .enter().append("rect")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.val))
                .attr("width", x.bandwidth())
                .attr("height", d => Math.max(0, chartHeight - y(d.val)))
                .attr("fill", d => d.color)
                .attr("rx", 10);

            svg.selectAll(".val-text")
                .data(data)
                .enter().append("text")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", d => y(d.val) - 10)
                .attr("text-anchor", "middle")
                .attr("class", "font-extrabold fill-slate-800 text-sm")
                .text(d => d.val);

            svg.selectAll(".name-text")
                .data(data)
                .enter().append("text")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", chartHeight + 25)
                .attr("text-anchor", "middle")
                .attr("class", "font-bold text-[10px] fill-slate-400 uppercase tracking-widest")
                .text(d => d.name);
        }

        function renderLocationChart() {
            const svg = d3.select("#chart-location");
            const legend = d3.select("#location-legend");
            svg.selectAll("*").remove();
            legend.selectAll("*").remove();

            if (!filteredData.length) return;

            const cats = allCategories;
            const colorScale = getCategoryColor;

            const grouped = d3.rollup(filteredData,
                v => d3.rollup(v, g => g.length, d => d.Category || "Other"),
                d => d.location
            );

            const data = Array.from(grouped, ([loc, cMap]) => {
                const row = { location: loc };
                let total = 0;
                cats.forEach(c => {
                    const count = cMap.get(c) || 0;
                    row[c] = count;
                    total += count;
                });
                row._total = total;
                return row;
            }).sort((a, b) => b._total - a._total);

            const margin = { top: 10, right: 60, bottom: 40, left: 140 };
            const containerWidth = document.getElementById("location-chart-container").clientWidth - 48;
            const width = Math.max(containerWidth, 600) - margin.left - margin.right;
            const height = data.length * BAR_ROW_HEIGHT;

            svg.attr("height", height + margin.top + margin.bottom)
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`);

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([0, d3.max(data, d => d._total) * 1.1 || 1]).range([0, width]);
            const y = d3.scaleBand().domain(data.map(d => d.location)).range([0, height]).padding(0.25);

            g.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x)
                    .ticks(5)
                    .tickSize(-height)
                    .tickFormat("")
                );

            g.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y)
                    .tickSize(-width)
                    .tickFormat("")
                );

            const xAxis = d3.axisBottom(x).ticks(5).tickSize(5);
            g.append("g")
                .attr("transform", `translate(0, ${height})`)
                .attr("class", "axis-line axis-text")
                .call(xAxis);

            g.append("g")
                .call(d3.axisLeft(y).tickSize(0))
                .call(g => g.select(".domain").remove())
                .selectAll("text")
                .attr("class", "font-bold text-slate-700")
                .style("font-size", "11px");

            const stack = d3.stack().keys(cats)(data);

            const layer = g.selectAll(".layer")
                .data(stack)
                .enter().append("g")
                .attr("fill", d => colorScale(d.key));

            layer.selectAll("rect")
                .data(d => d)
                .enter().append("rect")
                .attr("y", d => y(d.data.location))
                .attr("x", d => x(d[0]))
                .attr("width", d => Math.max(0, x(d[1]) - x(d[0])))
                .attr("height", y.bandwidth())
                .attr("rx", 4)
                .on("mouseover", function (event, d) {
                    const key = d3.select(this.parentNode).datum().key;
                    tooltip.transition().duration(100).style("opacity", 1);
                    tooltip.html(`<strong>${key}</strong>: ${d[1] - d[0]} tickets`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    d3.select(this).attr("opacity", 0.8);
                })
                .on("mouseout", function () {
                    tooltip.transition().duration(200).style("opacity", 0);
                    d3.select(this).attr("opacity", 1);
                });

            layer.selectAll(".bar-label")
                .data(d => d)
                .enter().append("text")
                .attr("y", d => y(d.data.location) + y.bandwidth() / 2)
                .attr("x", d => x(d[0]) + (x(d[1]) - x(d[0])) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .attr("fill", "white")
                .attr("class", "font-bold text-[9px] pointer-events-none")
                .text(d => {
                    const val = d[1] - d[0];
                    return (x(d[1]) - x(d[0]) > 25) ? val : "";
                });

            g.selectAll(".total-label")
                .data(data)
                .enter().append("text")
                .attr("y", d => y(d.location) + y.bandwidth() / 2)
                .attr("x", d => x(d._total) + 8)
                .attr("dy", "0.35em")
                .attr("class", "font-bold text-slate-400 text-[10px]")
                .text(d => d._total);

            cats.forEach(c => {
                const item = legend.append("div").attr("class", "legend-item");
                item.append("div").attr("class", "legend-box").style("background-color", colorScale(c));
                item.append("span").text(c);
            });
        }

        function renderTechnicianPieChart() {
            const svg = d3.select("#chart-technician-pie");
            const legend = d3.select("#technician-legend");
            svg.selectAll("*").remove();
            legend.selectAll("*").remove();

            if (!filteredData.length) return;

            const techCounts = d3.rollup(filteredData, v => v.length, d => d.tech);
            const data = Array.from(techCounts, ([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value);

            const total = d3.sum(data, d => d.value);
            const width = 300, height = 300, radius = Math.min(width, height) / 2 - 20;
            const color = d3.scaleOrdinal(d3.schemeTableau10);

            const pie = d3.pie().value(d => d.value).sort(null);
            const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius);
            const labelArc = d3.arc().innerRadius(radius * 0.7).outerRadius(radius * 0.7);

            const g = svg.attr("viewBox", `0 0 ${width} ${height}`)
                .append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);

            const paths = g.selectAll(".arc")
                .data(pie(data))
                .enter().append("g");

            paths.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.name))
                .attr("stroke", "#fff")
                .attr("stroke-width", "2px")
                .attr("class", "transition-all hover:opacity-80 cursor-pointer");

            paths.append("text")
                .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .attr("class", "fill-slate-800 text-[10px] font-bold pointer-events-none")
                .text(d => {
                    const pct = (d.data.value / total * 100);
                    return pct > 5 ? `${pct.toFixed(0)}%` : "";
                });

            data.forEach((d, i) => {
                const item = legend.append("div").attr("class", "flex items-center justify-between text-xs py-1.5 border-b border-slate-50 last:border-0");
                const left = item.append("div").attr("class", "flex items-center");
                left.append("div").attr("class", "legend-box").style("background-color", color(d.name));
                left.append("span").attr("class", "font-semibold text-slate-700 truncate max-w-[120px]").text(d.name);
                item.append("span").attr("class", "text-slate-400 font-mono").text(`${d.value} tkt`);
            });
        }

        function renderKPILeaderboard() {
            const tbody = document.getElementById('tech-kpi-body');
            const techMap = d3.rollup(filteredData,
                v => {
                    const totalCount = v.length;
                    const metCount = v.filter(d => !d.sla_breach).length;
                    return { total: totalCount, met: metCount };
                },
                d => d.tech
            );

            const data = Array.from(techMap, ([name, stats]) => ({ name, ...stats }))
                .sort((a, b) => b.total - a.total);

            tbody.innerHTML = data.map(d => {
                const metRate = d.total > 0 ? (d.met / d.total * 100) : 0;
                let perfColor = 'text-emerald-500';
                if (metRate < 85) perfColor = 'text-amber-500';
                if (metRate < 70) perfColor = 'text-rose-500';

                return `<tr>
                    <td class="px-6 py-4 font-bold text-slate-800">${d.name}</td>
                    <td class="px-6 py-4 text-center font-mono text-slate-500">${d.total}</td>
                    <td class="px-6 py-4 text-center font-mono text-indigo-600 font-bold">${d.met}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="font-black ${perfColor}">${metRate.toFixed(1)}%</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="flex-1 bg-slate-100 h-2 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-500" style="width: ${Math.min(metRate, 100)}%"></div>
                            </div>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderTable() {
            const tbody = document.querySelector('#ticket-details-table tbody');
            const sortKey = elements['sort-filter'] ? elements['sort-filter'].value : 'date';

            const sorted = [...filteredData].sort((a, b) => {
                if (sortKey === 'date') return a.opening_date - b.opening_date;
                if (sortKey === 'location') return a.location.localeCompare(b.location);
                if (sortKey === 'plate') {
                    const plateA = (a['Associated elements'] || a['Associated Elements'] || '-').toString();
                    const plateB = (b['Associated elements'] || b['Associated Elements'] || '-').toString();
                    return plateA.localeCompare(plateB);
                }
                return 0;
            });

            tbody.innerHTML = sorted.map(d => {
                const config = statusConfig[d.Status] || defaultStatus;
                const breachUI = d.sla_breach
                    ? '<span class="text-rose-600 font-bold flex items-center"><svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>BREACH</span>'
                    : '<span class="text-emerald-500 font-medium">OK</span>';

                return `<tr class="${d.sla_breach ? 'sla-breach' : ''}">
                    <td class="px-4 py-3 font-mono text-slate-400 text-xs">${d.ID}</td>
                    <td class="px-4 py-3 font-semibold text-slate-700 truncate max-w-xs">${d.Title}</td>
                    <td class="px-4 py-3">
                        <span class="status-pill ${config.bg} ${config.text} border ${config.border}">${d.Status}</span>
                    </td>
                    <td class="px-4 py-3 text-slate-500">${d.tech}</td>
                    <td class="px-4 py-3 text-slate-500 font-medium">${d.Category || '-'}</td>
                    <td class="px-4 py-3 text-slate-500">${d.location}</td>
                    <td class="px-4 py-3 text-slate-500">${d['Associated elements'] || d['Associated Elements'] || '-'}</td>
                    <td class="px-4 py-3 text-slate-400">${TABLE_DATE_FORMAT(d.opening_date)}</td>
                    <td class="px-4 py-3">${breachUI}</td>
                </tr>`;
            }).join('');
        }

        function updateDashboard(force = false) {
            if (!force && currentPage !== 'performance') return;
            applyFilters();
            updateStatistics();
            renderStatusFunnel();
            renderLocationChart();
            renderTechnicianPieChart();
            renderKPILeaderboard();
            renderTable();
        }

        const resizeObserver = new ResizeObserver(() => {
            if (filteredData.length && currentPage === 'performance') {
                renderLocationChart();
                renderTechnicianPieChart();
            }
            if (filteredDataP2.length && currentPage === 'analysis') {
                renderLocationTreemapP2();
                renderPlateStackedBarP2();
            }
        });
        resizeObserver.observe(document.getElementById('location-chart-container'));
        resizeObserver.observe(document.getElementById('plate-chart-container-p2'));
    </script>
</body>

</html>